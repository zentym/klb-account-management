<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KLB Custom Login Demo (CORS Fixed)</title>
    <style>
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .title {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-size: 14px;
            font-weight: bold;
        }

        .input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
        }

        .login-button {
            background-color: #4CAF50;
            color: white;
            margin-bottom: 20px;
        }

        .login-button:hover:not(:disabled) {
            background-color: #45a049;
        }

        .login-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .logout-button {
            background-color: #f44336;
            color: white;
        }

        .logout-button:hover:not(:disabled) {
            background-color: #da190b;
        }

        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
            border: 1px solid #ffcdd2;
        }

        .success {
            background-color: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .user-info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .demo-users {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }

        .demo-button {
            margin: 5px;
            padding: 8px 12px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .demo-button:hover {
            background-color: #1976D2;
        }

        .hidden {
            display: none;
        }

        .token-display {
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            max-height: 100px;
            overflow-y: auto;
        }

        .permissions {
            margin-top: 15px;
        }

        .permission-item {
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
        }

        .has-permission {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        .no-permission {
            background-color: #ffebee;
            color: #c62828;
        }

        .cors-warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- CORS Warning -->
        <div class="cors-warning">
            <strong>‚ö†Ô∏è CORS Issue Detected</strong><br>
            Browser ch·∫∑n CORS request. S·ª≠ d·ª•ng m·ªôt trong c√°c c√°ch sau:<br>
            1. <strong>Chrome:</strong> chrome.exe --disable-web-security --user-data-dir="C:\temp\chrome_dev"<br>
            2. <strong>Backend Proxy:</strong> T·∫°o proxy endpoint<br>
            3. <strong>React Dev Server:</strong> D√πng proxy trong package.json
        </div>

        <!-- Login Form -->
        <div id="loginForm">
            <h2 class="title">üîê KLB Custom Login Demo</h2>
            <p class="subtitle">Test trang ƒëƒÉng nh·∫≠p t√πy ch·ªânh v·ªõi Keycloak API</p>

            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="label" for="phoneNumber">ÔøΩ S·ªë ƒëi·ªán tho·∫°i:</label>
                    <input type="tel" id="phoneNumber" class="input" value="0987654321" required>
                </div>

                <div class="form-group">
                    <label class="label" for="password">üîí M·∫≠t kh·∫©u:</label>
                    <input type="password" id="password" class="input" value="password123" required>
                </div>

                <div id="errorMessage" class="error hidden"></div>

                <button type="submit" id="loginButton" class="button login-button">
                    üöÄ ƒêƒÉng nh·∫≠p
                </button>
            </form>

            <!-- Test Buttons -->
            <div style="margin: 20px 0;">
                <button class="demo-button" onclick="testKeycloakConnection()">
                    üîç Test Keycloak Connection
                </button>
                <button class="demo-button" onclick="testCORS()">
                    üåê Test CORS
                </button>
                <button class="demo-button" onclick="showSolution()">
                    üí° Show Solution
                </button>
            </div>

            <div class="demo-users">
                <h4>üß™ T√†i kho·∫£n demo:</h4>
                <button class="demo-button" onclick="fillCredentials('testuser', 'password123')">
                    testuser / password123 (USER)
                </button>
                <button class="demo-button" onclick="fillCredentials('admin', 'admin123')">
                    admin / admin123 (ADMIN - n·∫øu c√≥)
                </button>
            </div>
        </div>

        <!-- Success View -->
        <div id="successView" class="hidden">
            <h2 class="title">üéâ ƒêƒÉng nh·∫≠p th√†nh c√¥ng!</h2>

            <div class="success">
                <strong>‚úÖ X√°c th·ª±c th√†nh c√¥ng v·ªõi Keycloak!</strong><br>
                B·∫°n ƒë√£ ƒëƒÉng nh·∫≠p th√†nh c√¥ng b·∫±ng Custom Login UI.
            </div>

            <div class="user-info">
                <h3>üë§ Th√¥ng tin ng∆∞·ªùi d√πng:</h3>
                <div id="userDetails"></div>
            </div>

            <div class="user-info">
                <h3>üîê Token Info:</h3>
                <div>
                    <strong>Access Token (50 k√Ω t·ª± ƒë·∫ßu):</strong><br>
                    <div id="accessTokenPreview" class="token-display"></div>
                </div>
                <div style="margin-top: 10px;">
                    <strong>Refresh Token (30 k√Ω t·ª± ƒë·∫ßu):</strong><br>
                    <div id="refreshTokenPreview" class="token-display"></div>
                </div>
            </div>

            <div class="permissions">
                <h3>üõ°Ô∏è Quy·ªÅn h·∫°n:</h3>
                <div id="permissionsList"></div>
            </div>

            <button onclick="handleLogout()" id="logoutButton" class="button logout-button">
                üö™ ƒêƒÉng xu·∫•t
            </button>
        </div>

        <!-- Solutions -->
        <div id="solutionsView" class="hidden">
            <h3>üí° Solutions for CORS Issue</h3>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 10px 0;">
                <h4>Option 1: Chrome with Disabled Security (Quick Test)</h4>
                <code style="background: #e9ecef; padding: 10px; display: block; border-radius: 4px;">
                    chrome.exe --disable-web-security --user-data-dir="C:\temp\chrome_dev"
                </code>
            </div>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 10px 0;">
                <h4>Option 2: Backend Proxy (Production)</h4>
                <p>T·∫°o endpoint trong API Gateway:</p>
                <code style="background: #e9ecef; padding: 10px; display: block; border-radius: 4px;">
                    POST /api/auth/keycloak/token<br>
                    ‚Üí Forwards to Keycloak
                </code>
            </div>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 10px 0;">
                <h4>Option 3: React Dev Server (Development)</h4>
                <p>package.json proxy config:</p>
                <code style="background: #e9ecef; padding: 10px; display: block; border-radius: 4px;">
                    "proxy": "http://localhost:8090"
                </code>
            </div>

            <button class="button login-button" onclick="backToLogin()">
                üîô Back to Login
            </button>
        </div>
    </div>

    <script>
        // Enhanced Custom Keycloak Service with CORS handling
        class CustomKeycloakService {
            constructor() {
                this.baseUrl = 'http://localhost:8090';
                this.realm = 'Kienlongbank';
                this.clientId = 'klb-frontend';
            }

            async login(phoneNumber, password) {
                try {
                    // Try direct approach first
                    const response = await fetch(`${this.baseUrl}/realms/${this.realm}/protocol/openid-connect/token`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        mode: 'cors', // Explicitly set CORS mode
                        body: new URLSearchParams({
                            grant_type: 'password',
                            client_id: this.clientId,
                            username: phoneNumber, // Send phoneNumber as username to Keycloak
                            password: password,
                        }),
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const tokenData = await response.json();
                    const payload = this.decodeJWT(tokenData.access_token);

                    const userInfo = {
                        username: payload.preferred_username || username,
                        email: payload.email,
                        name: payload.name,
                        roles: payload.realm_access?.roles || [],
                        token: tokenData.access_token,
                        refreshToken: tokenData.refresh_token,
                    };

                    // Store in localStorage
                    localStorage.setItem('klb_user_info', JSON.stringify(userInfo));
                    localStorage.setItem('klb_access_token', tokenData.access_token);
                    localStorage.setItem('klb_refresh_token', tokenData.refresh_token);

                    return userInfo;

                } catch (error) {
                    console.error('Login error:', error);

                    // Check if it's a CORS error
                    if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                        throw new Error('CORS Error: Browser ch·∫∑n request. Xem h∆∞·ªõng d·∫´n gi·∫£i quy·∫øt b√™n d∆∞·ªõi.');
                    } else if (error.message.includes('401')) {
                        throw new Error('T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng');
                    } else if (error.message.includes('400')) {
                        throw new Error('D·ªØ li·ªáu ƒë·∫ßu v√†o kh√¥ng h·ª£p l·ªá');
                    } else {
                        throw new Error(`K·∫øt n·ªëi th·∫•t b·∫°i: ${error.message}`);
                    }
                }
            }

            decodeJWT(token) {
                try {
                    const parts = token.split('.');
                    if (parts.length !== 3) return {};

                    const payload = parts[1];
                    const decoded = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
                    return JSON.parse(decoded);
                } catch (error) {
                    console.error('Error decoding JWT:', error);
                    return {};
                }
            }

            getCurrentUser() {
                const userInfoStr = localStorage.getItem('klb_user_info');
                if (!userInfoStr) return null;

                try {
                    return JSON.parse(userInfoStr);
                } catch (error) {
                    console.error('Error parsing user info:', error);
                    return null;
                }
            }

            async logout() {
                localStorage.removeItem('klb_user_info');
                localStorage.removeItem('klb_access_token');
                localStorage.removeItem('klb_refresh_token');
            }

            hasRole(role) {
                const user = this.getCurrentUser();
                return user ? user.roles.includes(role) : false;
            }

            isAdmin() {
                return this.hasRole('ADMIN') || this.hasRole('admin');
            }
        }

        // Initialize service
        const keycloakService = new CustomKeycloakService();

        // Enhanced handlers
        function fillCredentials(phoneNumber, password) {
            document.getElementById('phoneNumber').value = phoneNumber;
            document.getElementById('password').value = password;
            hideError();
        }

        async function handleLogin(event) {
            event.preventDefault();

            const phoneNumber = document.getElementById('phoneNumber').value;
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('loginButton');

            loginButton.disabled = true;
            loginButton.textContent = 'üîÑ ƒêang ƒëƒÉng nh·∫≠p...';

            hideError();

            try {
                const userInfo = await keycloakService.login(phoneNumber, password);
                console.log('Login successful:', userInfo);
                showSuccessView(userInfo);
            } catch (error) {
                console.error('Login failed:', error);
                showError(error.message);
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'üöÄ ƒêƒÉng nh·∫≠p';
            }
        }

        async function handleLogout() {
            const logoutButton = document.getElementById('logoutButton');

            logoutButton.disabled = true;
            logoutButton.textContent = 'üîÑ ƒêang ƒëƒÉng xu·∫•t...';

            try {
                await keycloakService.logout();
                console.log('Logout successful');
                showLoginForm();
            } catch (error) {
                console.error('Logout failed:', error);
            } finally {
                logoutButton.disabled = false;
                logoutButton.textContent = 'üö™ ƒêƒÉng xu·∫•t';
            }
        }

        // Test functions
        async function testKeycloakConnection() {
            try {
                const response = await fetch('http://localhost:8090/realms/Kienlongbank/.well-known/openid_configuration');
                if (response.ok) {
                    showError('‚úÖ Keycloak connection OK! Issue is CORS policy.');
                } else {
                    showError('‚ùå Keycloak not accessible');
                }
            } catch (error) {
                showError('‚ùå Connection failed: ' + error.message);
            }
        }

        async function testCORS() {
            try {
                const response = await fetch('http://localhost:8090/realms/Kienlongbank/protocol/openid-connect/token', {
                    method: 'POST',
                    mode: 'no-cors' // This will always "succeed" but we can't read the response
                });
                showError('üîç CORS test completed. Check browser console for details.');
            } catch (error) {
                showError('üîç CORS Error: ' + error.message);
            }
        }

        function showSolution() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('solutionsView').classList.remove('hidden');
        }

        function backToLogin() {
            document.getElementById('solutionsView').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        // UI helper functions
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.innerHTML = message;
            errorElement.classList.remove('hidden');
        }

        function hideError() {
            const errorElement = document.getElementById('errorMessage');
            errorElement.classList.add('hidden');
        }

        function showSuccessView(userInfo) {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('successView').classList.remove('hidden');

            document.getElementById('userDetails').innerHTML = `
                <div><strong>T√™n ƒëƒÉng nh·∫≠p:</strong> ${userInfo.username}</div>
                <div><strong>Email:</strong> ${userInfo.email || 'N/A'}</div>
                <div><strong>H·ªç t√™n:</strong> ${userInfo.name || 'N/A'}</div>
                <div><strong>Vai tr√≤:</strong> ${userInfo.roles.join(', ')}</div>
            `;

            document.getElementById('accessTokenPreview').textContent = userInfo.token.substring(0, 50) + '...';
            document.getElementById('refreshTokenPreview').textContent = userInfo.refreshToken.substring(0, 30) + '...';

            const permissionsList = document.getElementById('permissionsList');
            permissionsList.innerHTML = `
                <div class="permission-item ${keycloakService.isAdmin() ? 'has-permission' : 'no-permission'}">
                    ${keycloakService.isAdmin() ? '‚úÖ' : '‚ùå'} Admin Access
                </div>
                <div class="permission-item ${keycloakService.hasRole('USER') ? 'has-permission' : 'no-permission'}">
                    ${keycloakService.hasRole('USER') ? '‚úÖ' : '‚ùå'} User Access
                </div>
            `;
        }

        function showLoginForm() {
            document.getElementById('successView').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('username').value = 'testuser';
            document.getElementById('password').value = 'password123';
            hideError();
        }

        // Check if user is already logged in
        window.addEventListener('load', function () {
            const user = keycloakService.getCurrentUser();
            if (user) {
                showSuccessView(user);
            }
        });
    </script>
</body>

</html>